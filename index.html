<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nano Banana AI è€ç…§ç‰‡ä¿®å¤ - ç²¾è‡´ä½“éªŒ</title>
    <style>
        /* è‹¹æœé£æ ¼åŸºç¡€æ ·å¼ */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            max-width: 1000px; 
            margin: 0 auto; 
            padding: 20px; 
            background-color: #f7f7f7; 
            color: #1c1c1e;
        }
        h1 { 
            font-weight: 600; 
            text-align: center;
            margin-bottom: 5px;
            letter-spacing: -0.5px;
        }
        p { 
            text-align: center; 
            color: #6a6a6a; 
            margin-bottom: 30px; 
        }

        /* å¡ç‰‡å’Œè¾“å…¥åŒºåŸŸæ ·å¼ */
        .card {
            background: #ffffff;
            border-radius: 12px; 
            padding: 25px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05); 
            margin-bottom: 20px;
        }

        /* è¡¨å•å…ƒç´  */
        textarea, input[type="file"] { 
            width: 100%; 
            padding: 10px; 
            margin-top: 8px; 
            border: 1px solid #d1d1d6; 
            border-radius: 8px; 
            box-sizing: border-box; 
            transition: border-color 0.2s; 
        }
        textarea:focus, input[type="file"]:focus {
            border-color: #007aff; 
            outline: none;
        }

        button { 
            background-color: #007aff; 
            color: white; 
            padding: 12px 20px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 16px;
            font-weight: 600;
            margin-top: 15px;
            width: 100%;
            transition: opacity 0.2s;
        }
        button:hover { 
            opacity: 0.85; 
        }
        button:disabled {
            opacity: 0.5;
            cursor: default;
        }

        /* ç»“æœå±•ç¤ºåŒº */
        .results-container { 
            display: flex; 
            gap: 20px; 
        }
        .result-column { flex: 1; }
        .image-display { 
            max-width: 100%; 
            height: auto; 
            border: 1px solid #e5e5ea; 
            border-radius: 6px; 
            display: block; 
            margin-top: 10px;
        }
        
        /* çŠ¶æ€ä¿¡æ¯ */
        #loading { 
            display: none; 
            color: #007aff; 
            font-weight: 500; 
            margin-top: 15px;
            text-align: center;
        }
        .error { color: #ff3b30; font-weight: bold; text-align: center; }

        /* å“åº”å¼é€‚é… (H5) */
        @media screen and (max-width: 768px) {
            body { padding: 15px; }
            h1 { font-size: 28px; }
            .results-container { 
                flex-direction: column; 
                gap: 15px;
            }
            .card { padding: 15px; }
            button { padding: 10px 15px; font-size: 15px; }
        }
    </style>
</head>
<body>
    <h1>Nano Banana | è®°å¿†å¤åŸ</h1>
    <p>é«˜å“è´¨ AI ä¿®å¤å’Œæ™ºèƒ½ç€è‰²ï¼Œè®©è€ç…§ç‰‡ç„•å‘ç”Ÿæœºã€‚</p>

    <div class="card">
        <form id="repairForm">
            <label for="photoFile">ğŸ’¾ ä¸Šä¼ æ‚¨çš„è€ç…§ç‰‡ (JPG, PNG, WebP, æœ€å¤§ 10MB):</label><br>
            <input type="file" id="photoFile" name="photo" accept="image/jpeg, image/png, image/webp" required><br><br>
            
            <label for="presetPrompt">ğŸ¨ ä¿®å¤é¢„è®¾æ¨¡å¼:</label><br>
            <select id="presetPrompt" name="presetPrompt">
                <option value="åŸºç¡€ä¿®å¤ä¸ç€è‰²">åŸºç¡€ä¿®å¤ä¸ç€è‰² (æ¨è)</option>
                <option value="é¢éƒ¨å¢å¼ºä¸å»æ¨¡ç³Š">é¢éƒ¨å¢å¼ºä¸å»æ¨¡ç³Š (äººåƒå¿…å¤‡)</option>
                <option value="é£æ ¼åŒ–è€ç…§ç‰‡ï¼ˆå¤å¤ï¼‰">é£æ ¼åŒ–è€ç…§ç‰‡ï¼ˆä¿ç•™å¤å¤æ„Ÿï¼‰</option>
            </select><br><br>
            
            <label for="customPrompt">âœ¨ è‡ªå®šä¹‰æŒ‡ä»¤ (å¯é€‰):</label><br>
            <textarea id="customPrompt" name="customPrompt" rows="3" placeholder="ä¾‹å¦‚ï¼šæŠŠèƒŒæ™¯çš„é¢œè‰²æ”¹æˆæ·¡ç»¿è‰²ï¼Œè®©å·¦è¾¹äººç‰©çš„å¤´å‘æ›´é»‘ä¸€äº›ã€‚"></textarea><br>
            
            <button type="submit" id="submitButton">å¼€å§‹ AI ä¿®å¤</button>
        </form>
    </div>

    <p id="loading">â³ æ­£åœ¨ä½¿ç”¨ AI æ¨¡å‹å¤„ç†ä¸­...</p>
    <p id="errorMsg" class="error"></p>

    <div id="results" class="results-container">
        <div class="result-column card" style="display:none;" id="originalCard">
            <h3>ä¿®å¤å‰</h3>
            <img id="originalImage" class="image-display" src="" alt="åŸå›¾">
        </div>
        <div class="result-column card" style="display:none;" id="fixedCard">
            <h3>ä¿®å¤å</h3>
            <img id="fixedImage" class="image-display" src="" alt="ä¿®å¤åå›¾ç‰‡">
        </div>
    </div>

    <script>
        // Pages Function è½¬å‘è·¯å¾„ (å®‰å…¨ä¸”æ— éœ€ç¡¬ç¼–ç  Worker URL)
        const WORKER_ENDPOINT = '/api/repair'; 
        const MAX_SIZE_MB = 10;

        const form = document.getElementById('repairForm');
        const photoInput = document.getElementById('photoFile');
        const loading = document.getElementById('loading');
        const errorMsg = document.getElementById('errorMsg');
        const originalImage = document.getElementById('originalImage');
        const fixedImage = document.getElementById('fixedImage');
        const originalCard = document.getElementById('originalCard');
        const fixedCard = document.getElementById('fixedCard');
        const submitButton = document.getElementById('submitButton');

        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // UI çŠ¶æ€é‡ç½®
            errorMsg.textContent = '';
            loading.style.display = 'block';
            originalCard.style.display = 'none';
            fixedCard.style.display = 'none';
            submitButton.disabled = true;

            const file = photoInput.files[0];
            
            if (!file) {
                errorMsg.textContent = 'è¯·é€‰æ‹©ä¸€å¼ ç…§ç‰‡ã€‚';
                resetState();
                return;
            }

            if (file.size > MAX_SIZE_MB * 1024 * 1024) {
                errorMsg.textContent = `æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº ${MAX_SIZE_MB}MB çš„æ–‡ä»¶ã€‚`;
                resetState();
                return;
            }

            // 1. é¢„è§ˆåŸå›¾
            originalImage.src = URL.createObjectURL(file);
            originalCard.style.display = 'block';

            // 2. æ„é€  FormData
            const formData = new FormData();
            formData.append('photo', file);
        
            // è·å–é¢„è®¾å€¼å’Œè‡ªå®šä¹‰å€¼
            const presetValue = document.getElementById('presetPrompt').value;
            const customValue = document.getElementById('customPrompt').value;
        
            // ç»„åˆæœ€ç»ˆæç¤ºè¯ï¼šé¢„è®¾æç¤ºè¯ + ç”¨æˆ·çš„è‡ªå®šä¹‰æŒ‡ä»¤
            let finalPrompt = "";
            if (presetValue) {
                finalPrompt += `[é¢„è®¾æ¨¡å¼: ${presetValue}] `;
            }
            if (customValue.trim()) {
                finalPrompt += `[è‡ªå®šä¹‰æŒ‡ä»¤: ${customValue.trim()}]`;
            }
            
            // å¦‚æœä¸¤ä¸ªéƒ½ä¸ºç©ºï¼Œåˆ™ä½¿ç”¨ä¸€ä¸ªåŸºç¡€é»˜è®¤å€¼
            if (!finalPrompt) {
                finalPrompt = "è¯·ä¿®å¤å¹¶ç€è‰²è¿™å¼ è€ç…§ç‰‡ï¼Œå»é™¤æ‰€æœ‰åˆ’ç—•å’Œå™ªç‚¹ã€‚";
            }
        
            formData.append('prompt', finalPrompt);

            // 3. å‘é€è¯·æ±‚ç»™ Pages Function (/api/repair)
            try {
                const response = await fetch(WORKER_ENDPOINT, {
                    method: 'POST',
                    body: formData,
                });

                const result = await response.json();

                if (response.ok && result.status === 'success') {
                    // 4. æ˜¾ç¤ºä¿®å¤åçš„å›¾ç‰‡ (Base64 Data URL)
                    fixedImage.src = result.image;
                    fixedCard.style.display = 'block';
                    errorMsg.textContent = 'âœ… ä¿®å¤å®Œæˆï¼è¯·æŸ¥çœ‹å¯¹æ¯”å›¾ã€‚';
                } else {
                    errorMsg.textContent = `ä¿®å¤å¤±è´¥: ${result.message || 'æœªçŸ¥ Worker é”™è¯¯'}`;
                }
            } catch (error) {
                console.error('Network or processing error:', error);
                errorMsg.textContent = 'ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Pages Function æˆ– Worker éƒ¨ç½²ã€‚';
            } finally {
                resetState();
            }
        });

        function resetState() {
             loading.style.display = 'none';
             submitButton.disabled = false;
        }
    </script>
</body>
</html>
